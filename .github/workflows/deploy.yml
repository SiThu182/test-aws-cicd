name: Deploy to EC2

on:
  push:
    branches:
      - main  # Trigger on push to 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest  # GitHub Actions runner

    steps:
    # Step 1: Checkout the code
    - name: Checkout code
      uses: actions/checkout@v2

    # Step 2: Set up SSH key for EC2
    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "$EC2_SSH_PEM_BASE64" | base64 --decode > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 54.66.240.99 >> ~/.ssh/known_hosts

    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        npm install --force

    # Step 4: Build the project
    - name: Build project
      run: |
        npm run build

    # Step 5: Copy files to EC2
    - name: Copy files to EC2
      run: |
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -r ./build/* ubuntu@54.66.240.99:/var/www/html/azure/pteadmin/

    # Step 6: Restart Apache or other services
    # - name: Restart Apache on EC2
    #   run: |
    #     ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@54.66.240.99 "sudo systemctl restart apache2"

